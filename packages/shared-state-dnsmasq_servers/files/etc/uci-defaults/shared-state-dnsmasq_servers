#!/bin/sh

# dnsmasq upon SIGHUP will re-read this file containing "server=/example.com/1.2.3.4" lines
echo "servers-file=/var/shared-state/dnsmasq_servers" > "/etc/dnsmasq.d/shared-state-dnsmasq_servers.conf"

unique_append()
{
	grep -qF "$1" "$2" || echo "$1" >> "$2"
}

unique_append \
	'*/5 * * * * ((sleep $(($RANDOM % 120)); shared-state sync dnsmasq-servers &> /dev/null)&)'\
	/etc/crontabs/root
